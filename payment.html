<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Payment ‚Äî REIGNX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<nav class="navbar">
  <div class="nav-left">
    <a class="logo" href="index.html">REIGNX</a>
  </div>
</nav>
  <!-- CHECKOUT STEPS -->
	<div class="checkout-steps">
	  <div class="step completed">Cart</div>
	  <div class="step completed">Address</div>
	  <div class="step active">Payment</div>
	</div>
<main class="cart-page">
  <h1 class="cart-title">Payment</h1>

  <div class="cart-layout">
    <div class="cart-items">
      <h2>Select Payment Method</h2>

      <!-- <label><input type="radio" name="pay" checked /> Credit / Debit Card</label><br> -->
      
      <label>
        <input type="radio" name="pay" value="upi" checked />
        UPI (Scan & Pay)
      </label>

      <div id="upi-section" style="margin-top:20px">
        <p style="opacity:0.8">
          Scan the QR below and complete the payment
        </p>

        <img
          src="images/upi-qr.png"
          alt="UPI QR"
          style="max-width:260px;border:1px solid #333;border-radius:12px"
        />

        <p style="font-size:13px;opacity:0.6;margin-top:10px">
          After payment, click <b>Payment Done</b>
        </p>
      </div>

      <button class="checkout-btn" onclick="confirmUpiPayment()">
        I Have Paid
      </button>

      <button
        id="backBtn"
        class="checkout-btn"
        style="margin-bottom:20px;background:#111;color:#fff;border:1px solid #333"
        onclick="window.location.href='checkout.html'"
      >
        ‚Üê Back to Address
      </button>

      <!-- <label><input type="radio" name="pay" /> Cash on Delivery</label><br> -->

      <!-- <button class="checkout-btn" onclick="placeOrder()">
        Place Order
      </button> -->
    </div>

    <div class="cart-summary">
      <h2>Order Total</h2>
      <p>‚Çπ<strong><span id="cart-total">0</span></strong></p>
    </div>
  </div>
</main>

<script src="script.js"></script>
<script>
  renderCartTotalOnly();
</script>

<script>
async function confirmUpiPayment() {
  // üîí Disable back navigation immediately
  const backBtn = document.getElementById("backBtn");
  if (backBtn) backBtn.style.display = "none";

  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  const user = JSON.parse(localStorage.getItem("checkoutDetails"));

  if (!cart.length || !user) {
    alert("Order information missing. Please try again.");
    return;
  }

  // Optional UX lock
  document.body.style.pointerEvents = "none";
  document.body.style.opacity = "0.9";

  // Build email payload
  const orderData = {
    name: user.name,
    phone: user.phone,
    address: `${user.address}, ${user.city} - ${user.pincode}`,
    payment_method: "UPI",
    order: cart
  };

  // Send email using FormSubmit
  const form = document.createElement("form");
  form.action = "https://formsubmit.co/reignxcustomercare@gmail.com";
  form.method = "POST";

  // ‚úÖ Make order_details safe (only important info)
  const safeCart = cart.map(i => ({
    id: i.id,
    name: i.name,
    size: i.size,
    qty: Number(i.quantity || 1),
    price: Number(i.price || 0)
  }));

  const fields = {
    _subject: "NEW UPI ORDER ‚Äî REIGNX",
    _captcha: "false",
    _next: "https://reignx.in/success.html",

    // ‚úÖ INCLUDE CUSTOMER EMAIL (missing in your current code)
    customer_name: user.name,
    customer_email: user.email,
    customer_phone: user.phone,
    customer_address: `${user.address}, ${user.city} - ${user.pincode}`,

    payment_method: "UPI",
    order_details: JSON.stringify(safeCart)
  };

  for (const key in fields) {
    const input = document.createElement("input");
    input.type = "hidden";
    input.name = key;
    input.value = fields[key];
    form.appendChild(input);
  }

  document.body.appendChild(form);

  // üî• Reduce inventory FIRST
  try {
    await reduceInventoryAfterOrder(cart);
  } catch (e) {
    console.warn("Inventory update failed:", e);
    // ‚úÖ DO NOT STOP EMAIL FLOW
  }

  // Clear cart + checkout info
  localStorage.removeItem("cart");
  localStorage.removeItem("checkoutDetails");

  form.submit();
}
</script>
</body>
</html>