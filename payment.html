<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Payment ‚Äî REIGNX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<nav class="navbar">
  <div class="nav-left">
    <a class="logo" href="index.html">REIGNX</a>
  </div>
</nav>
  <!-- CHECKOUT STEPS -->
	<div class="checkout-steps">
	  <div class="step completed">Cart</div>
	  <div class="step completed">Address</div>
	  <div class="step active">Payment</div>
	</div>
<main class="cart-page">
  <h1 class="cart-title">Payment</h1>

  <div class="cart-layout">
    <div class="cart-items">
      <h2>Select Payment Method</h2>

      <!-- <label><input type="radio" name="pay" checked /> Credit / Debit Card</label><br> -->
      
      <label>
        <input type="radio" name="pay" value="upi" checked />
        UPI (Scan & Pay)
      </label>

      <div id="upi-section" style="margin-top:20px">
        <p style="opacity:0.8">
          Scan the QR below and complete the payment
        </p>

        <img
          src="images/upi-qr.png"
          alt="UPI QR"
          style="max-width:260px;border:1px solid #333;border-radius:12px"
        />

        <p style="font-size:13px;opacity:0.6;margin-top:10px">
          After payment, enter <b>UPI ID and then click I have paid button</b>
        </p>
      </div>
      <div style="margin-top:20px">
        <label style="display:block;margin-bottom:6px;opacity:0.85">
          UPI Transaction ID / UTR
        </label>
        <input
          type="text"
          id="utr"
          placeholder="Enter UPI Transaction ID"
          style="
            width:100%;
            padding:14px;
            border-radius:12px;
            border:1px solid rgba(255,255,255,0.2);
            background:rgba(255,255,255,0.06);
            color:#fff;
          "
          required
        />
      </div>
      <button class="checkout-btn" onclick="confirmUpiPayment()">
        I Have Paid
      </button>

      <button
        id="backBtn"
        class="checkout-btn"
        style="margin-bottom:20px;background:#111;color:#fff;border:1px solid #333"
        onclick="window.location.href='checkout.html'"
      >
        ‚Üê Back to Address
      </button>

      <!-- <label><input type="radio" name="pay" /> Cash on Delivery</label><br> -->

      <!-- <button class="checkout-btn" onclick="placeOrder()">
        Place Order
      </button> -->
    </div>

    <div class="cart-summary">
      <h2>Order Total</h2>
      <p>‚Çπ<strong><span id="cart-total">0</span></strong></p>
    </div>
  </div>
</main>

<script src="script.js"></script>
<script>
  renderCartTotalOnly();
</script>
<script>
  function generateOrderId() {
  const now = new Date();

  const mm = String(now.getMonth() + 1).padStart(2, "0");
  const dd = String(now.getDate()).padStart(2, "0");
  const yyyy = now.getFullYear();

  const dateKey = `${mm}${dd}${yyyy}`; // 12302025
  const storageKey = `reignx_order_count_${dateKey}`;

  let count = Number(localStorage.getItem(storageKey)) || 0;

  const orderId = `RX${dateKey}-${count}`;

  localStorage.setItem(storageKey, count + 1);

  return orderId;
}
</script>
<script>
async function confirmUpiPayment() {
  // üîí Disable back navigation immediately
  const backBtn = document.getElementById("backBtn");
  if (backBtn) backBtn.style.display = "none";

  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  const user = JSON.parse(localStorage.getItem("checkoutDetails"));
  const utr = document.getElementById("utr")?.value.trim();
  // üßæ Generate Order ID (daily incremental)
  const ORDER_ID = generateOrderId();

  if (!utr || utr.length < 6) {
    alert("Please enter a valid UPI Transaction ID");
    return;
  }

  const payBtn = document.querySelector(".checkout-btn");
  if (payBtn) {
    payBtn.disabled = true;
    payBtn.style.opacity = "0.6";
    payBtn.style.cursor = "not-allowed";
  }

  if (!cart.length || !user) {
    alert("Order information missing. Please try again.");
    return;
  }

  // Optional UX lock
  document.body.style.pointerEvents = "none";
  document.body.style.opacity = "0.9";

  // Build email payload
  const orderData = {
    name: user.name,
    phone: user.phone,
    address: `${user.address}, ${user.city} - ${user.pincode}`,
    payment_method: "UPI",
    order: cart
  };

  // Send email using FormSubmit
  const form = document.createElement("form");
  form.action = "https://formsubmit.co/reignxcustomercare@gmail.com";
  form.method = "POST";

  // ‚úÖ Make order_details safe (only important info)
  const safeCart = cart.map(i => ({
    id: i.id,
    name: i.name,
    size: i.size,
    qty: Number(i.quantity || 1),
    price: Number(i.price || 0)
  }));

  const productList = safeCart
    .map(i => `${i.name} (${i.size}) x ${i.qty}`)
    .join(", ");

  const fields = {
    _subject: `NEW ORDER ${ORDER_ID} ‚Äî REIGNX`,
    _captcha: "false",
    _next: "https://reignx.in/success.html",

    customer_name: user.name,
    customer_email: user.email,
    customer_phone: user.phone,
    customer_address: `${user.address}, ${user.city} - ${user.pincode}`,

    payment_method: "UPI",
    upi_transaction_id: utr,
    // üî• THIS FIXES URBAN JACKET EMAIL ISSUE
    products: productList,
    order_id: ORDER_ID,

    order_details: JSON.stringify(safeCart, null, 2)
  };

  for (const key in fields) {
    const input = document.createElement("input");
    input.type = "hidden";
    input.name = key;
    input.value = fields[key];
    form.appendChild(input);
  }

  document.body.appendChild(form);

  // üî• Reduce inventory FIRST
  try {
    await reduceInventoryAfterOrder(cart);
  } catch (e) {
    console.warn("Inventory update failed:", e);
    // ‚úÖ DO NOT STOP EMAIL FLOW
  }
  localStorage.setItem("last_order_id", ORDER_ID);
  // Clear cart + checkout info
  localStorage.removeItem("cart");
  localStorage.removeItem("checkoutDetails");

  form.submit();
}
</script>


</body>
</html>